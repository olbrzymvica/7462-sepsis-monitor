---
title: "Sepsis_report"
author: "Elzbieta Jodlowska-Siewert"
format: html
execute:
  eval: true
  echo: true
  warning: false
  message: false
editor: visual
---

```{r include=FALSE}
library(tidyverse)
library(ggplot2)
library(data.table)
library(lubridate)
library(googledrive)

source("sepsis_monitor_functions.R")

#the latest version of the report
file_link <- "https://drive.google.com/file/d/1XfmwcKpyQrX3UH0yF2ht6VwbmxHMuj1h/view?usp=share_link"
sepsis <- drive_read_string(file_link) %>%
  read_csv()

#previous version of the report
file_link <- "https://drive.google.com/file/d/1pH0zGLKzuQz9KqixikuPythYqgINWWob/view?usp=share_link"
sepsis_prev <- drive_read_string(file_link) %>%
  read_csv()
```

Table of all patients with sepsis and their vital signs:

```{r}
#Table 1
sepsis %>% filter(SepsisLabel==1) %>%
        select(-ICULOS, -SepsisLabel, -lastUpdate) %>%
        knitr::kable()
```

The changes in parameters in all patients with sepsis over the last hour:

```{r}
joined <- left_join(sepsis, sepsis_prev, by = "PatientID") 
joined %>% filter(SepsisLabel.x==1) %>%
    mutate(HR_change=HR.x-HR.y, Temp_change=Temp.x-Temp.y, Resp_change=Resp.x-Resp.y) %>%
    select(PatientID, HR_change, Temp_change, Resp_change) %>%
    knitr::kable()
```

Plots of changes in parameters for all patients who currently have sepsis:

```{r}
ids<- sepsis %>% filter(SepsisLabel==1) %>%
  select(PatientID) %>%
  unlist() %>%
  unname()

for (i in ids) {
  a<-getPatient(i)
  print(ggplot(data=a, aes(x=ICULOS, y=HR, group=1)) +
  geom_line()+
  geom_point())
  print(ggplot(data=a, aes(x=ICULOS, y=Temp, group=1)) +
  geom_line()+
  geom_point())
  print(ggplot(data=a, aes(x=ICULOS, y=Resp, group=1)) +
  geom_line()+
  geom_point())
}
```

